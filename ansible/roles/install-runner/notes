
# Setup runner in a vm (using packagemode now for testing)
sudo firewall-cmd --add-port=3000/tcp --zone=libvirt
sudo -u git /usr/local/bin/gitea actions generate-runner-token --config /etc/gitea/app.ini | sudo tee -a /var/www/html/gitea_action
sudo cp /var/www/html/ks/rhel94.cfg /var/www/html/ks/runner.cfg
sudo sed -i '/podman/d' /var/www/html/ks/runner.cfg
sudo sed -i '$d' /var/www/html/ks/runner.cfg
echo "dnf config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo" | sudo tee -a /var/www/html/ks/runner.cfg
echo "dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin" | sudo tee -a /var/www/html/ks/runner.cfg
echo "systemctl enable --now docker" | sudo tee -a /var/www/html/ks/runner.cfg
echo "CURRENT_RUNNER=$(curl -s https://dl.gitea.com/act_runner/ | grep href | grep name | head -1 | cut -d '/' -f 3)" | sudo tee -a /var/www/html/ks/runner.cfg
echo "curl -s https://dl.gitea.com/act_runner/\${CURRENT_RUNNER}/act_runner-\${CURRENT_RUNNER}-linux-amd64 -o /usr/bin/act_runner" | sudo tee -a /var/www/html/ks/runner.cfg
echo "chmod +x /usr/bin/act_runner" | sudo tee -a /var/www/html/ks/runner.cfg
echo "%end" | sudo tee -a /var/www/html/ks/runner.cfg
sudo sed -i 's/rhel94.cfg/runner.cfg/' /var/www/html/pxe/pxelinux.cfg/01-de-ad-be-ef-fa-d1

### Install the runner:
## Get a runner:
#CURRENT_RUNNER=$(curl -s https://dl.gitea.com/act_runner/ | grep href | grep name | head -1 | cut -d "/" -f 3)
#sudo curl -s https://dl.gitea.com/act_runner/${CURRENT_RUNNER}/act_runner-${CURRENT_RUNNER}-linux-amd64 -o /root/act_runner
#chmod +x /root/act_runner
## Setup the environment:
#sudo useradd act-runner -d /var/lib/act-runner
#sudo loginctl enable-linger act-runner
#sudo cp /root/act_runner /usr/local/bin/act-runner
#sudo mkdir /etc/act-runner
#sudo chown root:act-runner /etc/act-runner
#sudo chmod 770 /etc/act-runner
#sudo chown root:act-runner /usr/local/bin/act-runner
#sudo chmod ug+x /usr/local/bin/act-runner
## Configure the runner:
#sudo /usr/local/bin/act-runner generate-config | grep -v "^  #" | sudo tee -a /etc/act-runner/config.yaml
#sudo chown root:act-runner /etc/act-runner/config.yaml
#sudo chmod 640 /etc/act-runner/config.yaml
#sudo sed -i "s/.runner/\/var\/lib\/act-runner\/.runner/" /etc/act-runner/config.yaml
#sudo sed -i "s/docker_host.*/docker_host: \"unix:\/\/\/run\/podman\/podman.sock\"/" /etc/act-runner/config.yaml
#curl https://raw.githubusercontent.com/nodiscc/xsrv/refs/heads/master/roles/gitea_act_runner/templates/etc_systemd_system_act-runner.service.j2 | sudo tee -a /etc/systemd/system/act-runner.service
#sudo systemctl daemon-reload
## Register the runner:
#sudo -u act-runner /usr/local/bin/act-runner register -c /etc/act-runner/config.yaml --no-interactive --instance http://localhost:3000 --token $(sudo -u git /usr/local/bin/gitea actions generate-runner-token --config /etc/gitea/app.ini)
## Start the runner:
#sudo systemctl enable podman.socket --now
#sudo chgrp act-runner /run/podman/podman.sock
#sudo chmod g+x /run/podman/podman.sock
#sudo systemctl enable act-runner --now

#sudo sed -i 's/docker.gitea.com\/var\/lib\/act-runner\/.runner/gitea\/runner/' /var/lib/act-runner/.runner
cd ~/git/rhel9-soe/
cp /tmp/ImageModeWorkshop/files/Containerfile-rhel9-soe Containerfile
mkdir -p .gitea/workflows
cp /tmp/ImageModeWorkshop/files/build_rhel9-soe.yaml .gitea/workflows/build_rhel9.yaml
git add .
git commit -m "Initial Commit"
#git push  # Can't push until I have created and registered the runner
